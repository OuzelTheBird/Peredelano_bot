name: Deployment

concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:

  GitLeaks:
    name: 'GitLeaks'
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'GitLeaks: running'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  YAMLLint:
    name: 'YAMLLint'
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2.3.4

      - name: Installing PyLint
        run: python -m pip install yamllint

      - name: 'YAMLLint: runing'
        run: yamllint -c .yamllint.yml .

  PyLint:
    name: 'PyLint'
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2.3.4

      - name: 'PyLint: set up python'
        uses: actions/setup-python@v2

      - name: 'PyLint: loading cache (if exists)'
        uses: actions/cache@v2.1.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip
          restore-keys: ${{ runner.os }}-pip

      - name: 'PyLint: installing'
        run: python -m pip pylint

      - name: 'PyLint: running'
        run: pylint --recursive=y --rcfile ./.pylintrc

  hadoLint:
    name: 'hadoLint'
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      - name: 'hadoLint: runing'
        uses: hadolint/hadolint-action@master
        with:
          dockerfile: "Dockerfile"
          recursive: true
          config: ./.hadolint.yaml

  super-linter:
    name: 'super-linter'
    runs-on: ubuntu-latest
    steps:

      - name: 'super-linter: checkout code'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'super-linter: set validating only diff'
        if: github.ref_name != github.event.repository.default_branch
        run: echo "VALIDATE_ALL_CODEBASE=false" >> "$GITHUB_ENV"

      - name: 'super-linter: set validating all code'
        if: github.ref_name == github.event.repository.default_branch
        run: echo "VALIDATE_ALL_CODEBASE=true" >> "$GITHUB_ENV"

      - name: 'super-linter: runing'
        uses: github/super-linter@v4
        env:
          DISABLE_ERRORS: false
          LOG_LEVEL: WARN
          VALIDATE_ALL_CODEBASE: "${{ env.VALIDATE_ALL_CODEBASE }}"
          IGNORE_GITIGNORED_FILES: true
          VALIDATE_GITLEAKS: true
          VALIDATE_DOCKERFILE_HADOLINT: true
          VALIDATE_PYTHON: true
          VALIDATE_YAML: true
          VALIDATE_MARKDOWN: true
          VALIDATE_GITHUB_ACTIONS: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  Build:
    name: 'Build'
    needs: [super-linter, hadoLint, PyLint, YAMLLint, GitLeaks]
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: github.ref_name == github.event.repository.default_branch
    env:
      REGISTRY: ghcr.io
      TAG_NAME: latest
      CACHE_IMAGE_NAME: buildcache
    steps:

      - name: 'Build: checkout code'
        uses: actions/checkout@v3

      - name: 'Build: export lowercase image names'
        shell: bash
        # shellcheck disable=cs2086
        run: |
          : "${{ env.REGISTRY }}/${{ github.repository }}:latest"
          echo "IMAGE_TAG=${_,,}" | tee -a "$GITHUB_ENV"
          : "${{ env.REGISTRY }}/${{ github.repository }}/${{ env.CACHE_IMAGE_NAME }}:latest"
          echo "CACHE_IMAGE_TAG=${_,,}" | tee -a "$GITHUB_ENV"
      - name: 'Build: login to GHCR'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Build: set up docker Buildx'
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: 'Build: build and push docker image'
        uses: docker/build-push-action@v3
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: ./
          file: ./Dockerfile
          target: release
          tags: "${{ env.IMAGE_TAG }}"
          push: true
          cache-from: type=registry,ref=${{ env.CACHE_IMAGE_TAG }}
          cache-to: type=registry,ref=${{ env.CACHE_IMAGE_TAG }},mode=max

  release:
    name: 'Release'
    needs: Build
    runs-on: ubuntu-latest
    if: github.ref_name == github.event.repository.default_branch
    environment: production
    steps:

      - name: 'Release: checkout code'
        uses: actions/checkout@v3

      - name: 'Release: checkout and reloading application'
        uses: appleboy/ssh-action@master
        env:
          APP_ENV: ${{ secrets.ENV_PRODUCTION }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: 22
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: APP_ENV
          debug: true
          script: |
            if [[ ! -d "${{ github.event.repository.name }}/.git" ]]; then git clone ${{ github.server_url }}/${{ github.repository }} ${{ github.event.repository.name }} ; fi
            if [[ -d "${{ github.event.repository.name }}/.git" ]]; then cd ${{ github.event.repository.name }} && git checkout ${{ github.ref_name }} && git pull ; fi
            echo "$APP_ENV">  ./bot/secrets/.env
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose --file docker-compose.yml pull
            #docker compose --file docker-compose.yml build --pull --no-cache;
            docker compose --file docker-compose.yml up -d
            docker system prune --all --force;
            docker logout
